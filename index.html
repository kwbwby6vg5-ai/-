<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
  <title>Snake Game</title>
  <style>
    /* æ ¸å¿ƒé€‚é…å˜é‡ï¼šæ‰€æœ‰å°ºå¯¸åŸºäºæ­¤å˜é‡ç­‰æ¯”ä¾‹ç¼©æ”¾ */
    :root {
      --base-width: 400px; /* åŸºå‡†æ£‹ç›˜å®½åº¦ï¼ˆç”µè„‘/iPadæ ‡å‡†å°ºå¯¸ï¼‰ */
      --scale: 1; /* ç¼©æ”¾æ¯”ä¾‹ï¼ŒJSè‡ªåŠ¨è®¡ç®— */
      --cell-size: calc(20px * var(--scale)); /* æ¯ä¸ªæ ¼å­çš„å¤§å° */
      --safe-top: env(safe-area-inset-top); /* åˆ˜æµ·å±é¡¶éƒ¨å®‰å…¨è·ç¦» */
      --safe-bottom: env(safe-area-inset-bottom); /* åº•éƒ¨å®‰å…¨è·ç¦» */
    }

    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      background: #111;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      color: #fff;
      font-family: Arial, sans-serif;
      touch-action: none;
      min-height: 100vh;
      min-height: 100dvh;
      padding: calc(10px * var(--scale)) 0;
      padding-top: max(calc(10px * var(--scale)), var(--safe-top));
      padding-bottom: max(calc(10px * var(--scale)), var(--safe-bottom));
      width: 100%;
      overflow-x: hidden;
    }
    .screen { 
      display: flex; 
      flex-direction: column; 
      align-items: center; 
      gap: calc(20px * var(--scale)); 
      padding: calc(20px * var(--scale)); 
      width: 100%;
      max-width: calc(var(--base-width) * 1.2);
    }
    .hidden { display: none !important; }
    .menu-title { 
      font-size: calc(36px * var(--scale)); 
      color: #4CAF50; 
      text-align: center;
    }
    .mode-btn {
      width: calc(220px * var(--scale)); 
      height: calc(80px * var(--scale)); 
      border-radius: calc(16px * var(--scale)); 
      border: none;
      font-size: calc(24px * var(--scale)); 
      font-weight: bold; 
      color: white;
      cursor: pointer; 
      transition: all 0.2s;
    }
    .mode-btn.levels { background: #4CAF50; }
    .mode-btn.special { background: #64B5F6; }
    .mode-btn.locked { background: #555; opacity: 0.6; cursor: default; }
    .mode-btn.checked { background: #999; opacity: 0.7; cursor: default; }
    .level-grid {
      display: flex; 
      gap: calc(12px * var(--scale)); 
      flex-wrap: wrap;
      justify-content: center; 
      margin: calc(10px * var(--scale)) 0 calc(20px * var(--scale));
      width: 100%;
    }
    .level-block {
      width: calc(80px * var(--scale)); 
      height: calc(80px * var(--scale)); 
      border-radius: calc(12px * var(--scale));
      background: #333; 
      border: calc(2px * var(--scale)) solid #444;
      display: flex; 
      align-items: center; 
      justify-content: center;
      font-size: calc(18px * var(--scale)); 
      font-weight: bold; 
      color: #fff;
      cursor: pointer; 
      text-align: center; 
      line-height: 1.2;
    }
    .level-block.active { background: #4CAF50; border-color: #8BC34A; }
    .level-block.tutorial { background: #2196F3; border-color: #03A9F3; }
    .level-block.locked { background: #222; border-color: #333; color: #555; cursor: default; }
    .menu-btn {
      padding: calc(12px * var(--scale)) calc(24px * var(--scale)); 
      font-size: calc(18px * var(--scale)); 
      border-radius: calc(12px * var(--scale));
      border: none; 
      background: #333; 
      color: white; 
      min-width: calc(180px * var(--scale));
      cursor: pointer; 
      transition: all 0.2s;
    }
    .menu-btn.primary { background: #4CAF50; }
    .menu-btn.warning { background: #FF9800; }
    .menu-btn:active { transform: scale(0.98); }
    .lang-group { 
      display: flex; 
      gap: calc(10px * var(--scale)); 
      margin-top: calc(10px * var(--scale)); 
      flex-wrap: wrap;
      justify-content: center;
    }
    .lang-btn {
      padding: calc(8px * var(--scale)) calc(16px * var(--scale)); 
      border-radius: calc(8px * var(--scale)); 
      border: none;
      background: #555; 
      color: white; 
      font-size: calc(16px * var(--scale)); 
      cursor: pointer;
    }
    .lang-btn.active { background: #4CAF50; }
    .score-row { 
      display: flex; 
      align-items: center; 
      gap: calc(12px * var(--scale)); 
      margin-bottom: calc(10px * var(--scale)); 
      flex-wrap: wrap; 
      justify-content: center;
      width: 100%;
    }
    #score { font-size: calc(24px * var(--scale)); }
    #timer { font-size: calc(24px * var(--scale)); color: #FFEB3B; margin-left: calc(10px * var(--scale)); }
    #goldCount { font-size: calc(24px * var(--scale)); color: #FFD700; }
    #pause-btn {
      width: calc(48px * var(--scale)); 
      height: calc(48px * var(--scale)); 
      border-radius: 50%;
      background: #333; 
      border: calc(2px * var(--scale)) solid #666;
      box-shadow: 0 calc(2px * var(--scale)) calc(4px * var(--scale)) rgba(0,0,0,0.3);
      display: flex; 
      align-items: center; 
      justify-content: center;
      font-size: calc(20px * var(--scale)); 
      color: #fff; 
      cursor: pointer; 
      transition: all 0.2s;
    }
    #game-board {
      background: #222; 
      display: grid; 
      gap: calc(1px * var(--scale));
      border: calc(2px * var(--scale)) solid #444; 
      position: relative;
      grid-template-columns: repeat(20, var(--cell-size));
      grid-template-rows: repeat(20, var(--cell-size));
    }
    #game-board.tutorial {
      background-image: linear-gradient(#333 calc(1px * var(--scale)), transparent calc(1px * var(--scale))),
                        linear-gradient(90deg, #333 calc(1px * var(--scale)), transparent calc(1px * var(--scale)));
      background-size: var(--cell-size) var(--cell-size);
    }
    .tutorial-text {
      position: absolute; 
      top: calc(10px * var(--scale)); 
      left: calc(10px * var(--scale));
      color: #f44336; 
      font-size: calc(14px * var(--scale)); 
      font-weight: bold;
      line-height: 1.4; 
      text-shadow: 0 0 calc(2px * var(--scale)) #000; 
      z-index: 10;
      max-width: 90%;
    }
    #tips { 
      margin-top: calc(10px * var(--scale)); 
      color: #888; 
      text-align: center; 
      font-size: calc(14px * var(--scale));
      padding: 0 calc(10px * var(--scale));
    }
    .modal {
      position: fixed; 
      top: 0; 
      left: 0; 
      width: 100%; 
      height: 100%;
      background: rgba(0,0,0,0.95); 
      display: flex; 
      flex-direction: column;
      align-items: center; 
      justify-content: center; 
      z-index: 999;
      padding: calc(20px * var(--scale));
      padding-top: max(calc(20px * var(--scale)), var(--safe-top));
      padding-bottom: max(calc(20px * var(--scale)), var(--safe-bottom));
    }
    .device-btn, .skip-btn {
      font-size: calc(22px * var(--scale)); 
      padding: calc(14px * var(--scale)) calc(28px * var(--scale)); 
      margin: calc(10px * var(--scale));
      border-radius: calc(12px * var(--scale)); 
      border: none; 
      background: #4CAF50;
      color: white; 
      cursor: pointer;
    }
    .notice { 
      font-size: calc(14px * var(--scale)); 
      color: #FFEB3B; 
      margin-top: calc(15px * var(--scale)); 
      max-width: calc(300px * var(--scale)); 
      text-align: center; 
      line-height: 1.4; 
    }
    .victory-text { 
      font-size: calc(50px * var(--scale)); 
      color: #FFEB3B; 
      text-shadow: 0 0 calc(15px * var(--scale)) #FFEB3B; 
      margin-bottom: calc(20px * var(--scale));
      text-align: center;
    }
    .gameover-text { 
      font-size: calc(50px * var(--scale)); 
      color: #F44336; 
      text-shadow: 0 0 calc(15px * var(--scale)) #F44336; 
      margin-bottom: calc(20px * var(--scale));
      text-align: center;
    }
    .countdown { 
      font-size: calc(80px * var(--scale)); 
      color: #4CAF50; 
      font-weight: bold; 
      animation: flash 0.6s infinite alternate; 
    }
    .stage-title { 
      font-size: calc(36px * var(--scale)); 
      color: #FFEB3B; 
      margin-bottom: calc(20px * var(--scale)); 
      font-weight: bold;
      text-align: center;
    }
    .sign-title { 
      font-size: calc(32px * var(--scale)); 
      color: #FFD700; 
      margin-bottom: calc(20px * var(--scale)); 
      font-weight: bold;
      text-align: center;
    }
    .sign-desc { 
      font-size: calc(18px * var(--scale)); 
      color: #fff; 
      margin-bottom: calc(20px * var(--scale)); 
      text-align: center; 
      max-width: 90%;
    }
    .sign-list { 
      display: grid; 
      grid-template-columns: repeat(7, 1fr); 
      gap: calc(10px * var(--scale)); 
      margin-bottom: calc(25px * var(--scale)); 
      max-width: calc(600px * var(--scale)); 
      width: 100%; 
    }
    .sign-item {
      background: #333; 
      border-radius: calc(8px * var(--scale)); 
      padding: calc(10px * var(--scale)) calc(5px * var(--scale));
      display: flex; 
      flex-direction: column; 
      align-items: center; 
      gap: calc(5px * var(--scale));
      border: calc(2px * var(--scale)) solid #444;
    }
    .sign-item.checked { background: #4CAF50; border-color: #8BC34A; }
    .sign-item.today { border-color: #FFD700; }
    .sign-day { font-size: calc(14px * var(--scale)); color: #aaa; }
    .sign-item.checked .sign-day { color: #fff; }
    .sign-reward { font-size: calc(16px * var(--scale)); font-weight: bold; color: #FFD700; }
    .sign-item.checked .sign-reward { color: #fff; }
    .sign-progress { 
      width: 100%; 
      max-width: calc(600px * var(--scale)); 
      margin-bottom: calc(20px * var(--scale)); 
    }
    .progress-bar { 
      width: 100%; 
      height: calc(12px * var(--scale)); 
      background: #333; 
      border-radius: calc(6px * var(--scale)); 
      overflow: hidden; 
      margin-bottom: calc(10px * var(--scale)); 
    }
    .progress-fill { height: 100%; background: linear-gradient(90deg, #FFD700, #FFA500); transition: width 0.3s; }
    .progress-text { font-size: calc(16px * var(--scale)); color: #fff; text-align: center; }
    .reward-grid { 
      display: grid; 
      grid-template-columns: 1fr 1fr 1fr; 
      gap: calc(15px * var(--scale)); 
      width: 100%; 
      max-width: calc(600px * var(--scale)); 
      margin-bottom: calc(25px * var(--scale)); 
    }
    .reward-card {
      background: #333; 
      border-radius: calc(12px * var(--scale)); 
      padding: calc(15px * var(--scale)) calc(10px * var(--scale));
      display: flex; 
      flex-direction: column; 
      align-items: center; 
      gap: calc(8px * var(--scale));
      border: calc(2px * var(--scale)) solid #444; 
      text-align: center;
    }
    .reward-card.unlocked { border-color: #4CAF50; background: #2E7D32; }
    .reward-day { font-size: calc(16px * var(--scale)); font-weight: bold; color: #fff; }
    .reward-content { font-size: calc(14px * var(--scale)); color: #FFD700; }
    .reward-card.unlocked .reward-content { color: #fff; }
    @keyframes flash { from { opacity: 0.4; } to { opacity: 1; } }
    .final-score { 
      font-size: calc(28px * var(--scale)); 
      margin-bottom: calc(20px * var(--scale));
      text-align: center;
    }
    .restart-btn {
      padding: calc(12px * var(--scale)) calc(24px * var(--scale)); 
      border: none; 
      border-radius: calc(50px * var(--scale));
      background: #2196F3; 
      color: white; 
      font-size: calc(16px * var(--scale)); 
      cursor: pointer;
      margin: calc(5px * var(--scale));
    }
    .back-btn {
      padding: calc(12px * var(--scale)) calc(24px * var(--scale)); 
      border: none; 
      border-radius: calc(50px * var(--scale));
      background: #666; 
      color: white; 
      font-size: calc(16px * var(--scale)); 
      cursor: pointer;
      margin: calc(5px * var(--scale));
    }
    .star-row { 
      display: flex; 
      gap: calc(10px * var(--scale)); 
      margin: calc(5px * var(--scale)) 0; 
    }
    .star { font-size: calc(24px * var(--scale)); color: #ccc; }
    .star.active { color: #FFEB3B; }
    /* éšœç¢ç‰©æ ·å¼ */
    .obstacle {
      background-color: #E53935 !important;
      display: flex; 
      align-items: center; 
      justify-content: center;
      color: #FFD600; 
      font-size: calc(12px * var(--scale)); 
      font-weight: bold;
    }

    /* ç«–å±å°å±é¢å¤–ä¼˜åŒ– */
    @media (max-width: 500px) and (orientation: portrait) {
      .level-grid {
        gap: calc(8px * var(--scale));
      }
      .sign-list {
        gap: calc(6px * var(--scale));
      }
      .reward-grid {
        gap: calc(10px * var(--scale));
      }
    }
  </style>
</head>
<body>
<!-- ä¸»é¡µ -->
<div id="mainMenu" class="screen">
  <h1 class="menu-title">Snake Game</h1>
  <div class="score-row">
    <span id="goldCount">ğŸ’° 0</span>
  </div>
  <button class="menu-btn primary" id="startBtn">Start Game</button>
  <button class="menu-btn warning" id="signBtn">Daily Check-in</button>
  <div class="lang-group">
    <button class="lang-btn active" id="btn-en">English</button>
    <button class="lang-btn" id="btn-cn">ä¸­æ–‡</button>
  </div>
</div>

<!-- æ¨¡å¼é€‰æ‹©é¡µ -->
<div id="modeSelect" class="screen hidden">
  <h1 class="menu-title">Select Mode</h1>
  <button class="mode-btn levels" id="modeLevels">Levels</button>
  <button class="mode-btn special locked" id="modeSpecial">Special</button>
  <button class="menu-btn" id="backFromMode">Back</button>
</div>

<!-- å…³å¡é€‰æ‹©é¡µ -->
<div id="levelSelect" class="screen hidden">
  <h1 class="menu-title">Select Level</h1>
  <div class="level-grid" id="levelGrid">
    <div class="level-block tutorial" id="level-tutorial">T</div>
    <div class="level-block locked" id="level-1">1</div>
    <div class="level-block locked" id="level-2">2</div>
    <div class="level-block locked" id="level-3">3</div>
    <div class="level-block locked" id="level-4">4</div>
    <div class="level-block locked coming-soon"></div>
  </div>
  <button class="menu-btn" id="backFromLevels">Back</button>
</div>

<!-- ç‰¹æ®Šæ¨¡å¼é€‰æ‹©é¡µ -->
<div id="specialSelect" class="screen hidden">
  <h1 class="menu-title">Special</h1>
  <div class="level-grid" id="specialGrid">
    <div class="level-block active" id="special1">S1</div>
    <div class="level-block locked coming-soon"></div>
    <div class="level-block locked coming-soon"></div>
    <div class="level-block locked coming-soon"></div>
    <div class="level-block locked coming-soon"></div>
    <div class="level-block locked coming-soon"></div>
  </div>
  <button class="menu-btn" id="backFromSpecial">Back</button>
</div>

<!-- ç­¾åˆ°å¼¹çª— -->
<div id="signModal" class="modal hidden">
  <h2 class="sign-title">Daily Check-in</h2>
  <p class="sign-desc" id="signDesc">Check in every day to get gold coins!</p>
  <div class="sign-progress">
    <div class="progress-bar">
      <div class="progress-fill" id="progressFill" style="width: 0%"></div>
    </div>
    <p class="progress-text" id="progressText">Total Check-in: 0 days</p>
  </div>
  <div class="reward-grid">
    <div class="reward-card" id="reward7">
      <div class="reward-day">7 Days</div>
      <div class="reward-content">5000 Coins</div>
    </div>
    <div class="reward-card" id="reward30">
      <div class="reward-day">30 Days</div>
      <div class="reward-content">20000 Coins</div>
    </div>
    <div class="reward-card" id="reward50">
      <div class="reward-day">50 Days</div>
      <div class="reward-content">Limited Skin</div>
    </div>
  </div>
  <div class="sign-list" id="signList"></div>
  <div style="display: flex; gap: 10px; flex-wrap: wrap; justify-content: center;">
    <button class="menu-btn primary" id="doSignBtn">Check in Today</button>
    <button class="menu-btn" id="closeSignBtn">Close</button>
  </div>
</div>

<!-- æ¸¸æˆå¯¹å±€ç•Œé¢ -->
<div class="score-row hidden" id="scoreRow">
  <div id="score">Score: 0</div>
  <div id="timer">Time: 0</div>
  <button id="pause-btn">â¸</button>
</div>
<div id="game-board" class="hidden"></div>
<div id="tips" class="hidden">PC: â†‘â†“â†â†’ | Space=Pause | Mobile: Swipe</div>

<script>
  // å…¨å±€å…ƒç´ è·å–
  const gameBoard = document.getElementById('game-board');
  const scoreRow = document.getElementById('scoreRow');
  const scoreElement = document.getElementById('score');
  const timerElement = document.getElementById('timer');
  const pauseBtn = document.getElementById('pause-btn');
  const tips = document.getElementById('tips');
  const btnEn = document.getElementById('btn-en');
  const btnCn = document.getElementById('btn-cn');
  const startBtn = document.getElementById('startBtn');
  const mainMenu = document.getElementById('mainMenu');
  const modeSelect = document.getElementById('modeSelect');
  const modeLevels = document.getElementById('modeLevels');
  const modeSpecial = document.getElementById('modeSpecial');
  const backFromMode = document.getElementById('backFromMode');
  const levelSelect = document.getElementById('levelSelect');
  const backFromLevels = document.getElementById('backFromLevels');
  const specialSelect = document.getElementById('specialSelect');
  const backFromSpecial = document.getElementById('backFromSpecial');
  const levelTutorial = document.getElementById('level-tutorial');
  const level1 = document.getElementById('level-1');
  const level2 = document.getElementById('level-2');
  const level3 = document.getElementById('level-3');
  const level4 = document.getElementById('level-4');
  const special1 = document.getElementById('special1');
  const comingSoonElements = document.querySelectorAll('.coming-soon');
  const signBtn = document.getElementById('signBtn');
  const signModal = document.getElementById('signModal');
  const doSignBtn = document.getElementById('doSignBtn');
  const closeSignBtn = document.getElementById('closeSignBtn');
  const signList = document.getElementById('signList');
  const progressFill = document.getElementById('progressFill');
  const progressText = document.getElementById('progressText');
  const goldCount = document.getElementById('goldCount');
  const reward7 = document.getElementById('reward7');
  const reward30 = document.getElementById('reward30');
  const reward50 = document.getElementById('reward50');

  // æ¸¸æˆæ ¸å¿ƒæ•°æ®
  let hasDoneTutorial = localStorage.getItem('hasDoneTutorial') === 'true';
  let unlockedLevel2 = localStorage.getItem('unlockedLevel2') === 'true';
  let unlockedLevel3 = localStorage.getItem('unlockedLevel3') === 'true';
  let unlockedLevel4 = localStorage.getItem('unlockedLevel4') === 'true';
  let savedLevel = parseInt(localStorage.getItem('savedLevel')) || 0;
  let isSpecialMode = false;
  let specialStage = 1;
  let specialUnlockStage3 = localStorage.getItem('specialUnlockStage3') === 'true';
  let specialStar1 = localStorage.getItem('specialStar1') === 'true';
  let specialStar2 = localStorage.getItem('specialStar2') === 'true';
  let specialHighscore = parseInt(localStorage.getItem('specialHighscore') || 0);
  let specialTimeLeft = 0;
  let specialTimer;

  // ç­¾åˆ°&é‡‘å¸æ ¸å¿ƒæ•°æ®
  let userGold = parseInt(localStorage.getItem('userGold') || 0);
  let totalSignDays = parseInt(localStorage.getItem('totalSignDays') || 0);
  let lastSignDate = localStorage.getItem('lastSignDate') || '';
  let unlockedReward7 = localStorage.getItem('unlockedReward7') === 'true';
  let unlockedReward30 = localStorage.getItem('unlockedReward30') === 'true';
  let unlockedReward50 = localStorage.getItem('unlockedReward50') === 'true';
  const DAILY_GOLD = 1000;
  const today = new Date().toISOString().split('T')[0];

  let lang = 'en';
  let mode = null;
  let level = savedLevel;
  let gridSize = 20;
  let speed = 280;
  let baseSpeed = 280;
  let score = 0;
  let snake, food, direction;
  let gameLoop;
  let isGameStarted = false;
  let isPaused = false;
  let touchStartX = 0, touchStartY = 0;

  // æ¸¸æˆå¸¸é‡
  const STAGE1_TIME = 40;
  const STAGE1_SCORE = 80;
  const STAGE2_TIME = 60;
  const STAGE2_SCORE = 140;
  const STAGE3_TIME = 90;
  const LEVEL1_PASS = 150;
  const LEVEL2_PASS = 150;
  const LEVEL3_PASS = 150;
  const LEVEL4_PASS = 150;
  const TUTORIAL_PASS = 40;

  // ç¬¬å››å…³éšœç¢ç‰©
  const level4Obstacles = [
    {x:2, y:2}, {x:2, y:17},
    {x:17, y:2}, {x:17, y:17},
    {x:4, y:4}, {x:15, y:15}
  ];

  // åŒè¯­æ–‡æœ¬
  const langText = {
    cn: {
      start:'å¼€å§‹æ¸¸æˆ',selectLevel:'é€‰æ‹©å…³å¡',back:'è¿”å›',tutorial:'æ•™å­¦å…³',
      level1:'ç¬¬ä¸€å…³',level2:'ç¬¬äºŒå…³',level3:'ç¬¬ä¸‰å…³',level4:'ç¬¬å››å…³',
      chooseDevice:'é€‰æ‹©æ“ä½œæ–¹å¼',keyboard:'é”®ç›˜',mobile:'è§¦å±',
      keyboardGuide:'ä½¿ç”¨ â†‘ â†“ â† â†’ ç§»åŠ¨',mobileGuide:'æ»‘åŠ¨å±å¹•ç§»åŠ¨',
      ok:'ç¡®å®š',goal:'ç›®æ ‡ï¼šåƒæ‰é£Ÿç‰©',notice:'æ³¨æ„ï¼šç¢°å¢™/ç¢°è‡ªå·±å³å¤±è´¥',
      speedNotice:'æ³¨æ„ï¼šåƒåˆ°é£Ÿç‰©åé€Ÿåº¦ä¼šåŠ å¿«',
      obstacleNotice:'æ³¨æ„ï¼šçº¢è‰²éšœç¢ç‰©ä¸å¯è§¦ç¢°ï¼',
      specialGoal1:'é˜¶æ®µ1ï¼šçŸ­æ—¶é—´å†…å°½å¯èƒ½åƒæ›´å¤šé£Ÿç‰©\nè¾¾æ ‡ï¼š80 åˆ†',
      specialGoal2:'é˜¶æ®µ2ï¼šçŸ­æ—¶é—´å†…å°½å¯èƒ½åƒæ›´å¤šé£Ÿç‰©\nè¾¾æ ‡ï¼š140 åˆ†',
      specialGoal3:'æœ€ç»ˆé˜¶æ®µï¼šå…¨åŠ›å†²åˆºæœ€é«˜åˆ†ï¼',
      stageStart:'å³å°†è¿›å…¥ é˜¶æ®µ',
      tabletNotice:'å¹³æ¿ç”¨æˆ·å¯åœ¨æ¸¸ç©ä¸­éšæ„åˆ‡æ¢æ“ä½œæ–¹å¼',
      skipTutorial:'æ˜¯å¦è·³è¿‡æ•™å­¦å…³ï¼Ÿ',gameOver:'æ¸¸æˆç»“æŸ',
      tutorialComplete:'æ•™å­¦å®Œæˆï¼',victory:'æ­å–œè¿‡å…³ï¼',finalWin:'ä½ èµ¢äº†ï¼',
      perfect:'å®Œç¾é€šå…³ï¼',score:'åˆ†æ•°',nextLevel:'å³å°†è¿›å…¥ä¸‹ä¸€å…³',playAgain:'é‡æ–°å¼€å§‹',
      backToMenu:'å›åˆ°ä¸»é¡µ',
      tips:'ç”µè„‘: â†‘â†“â†â†’ ç§»åŠ¨ | ç©ºæ ¼æš‚åœ | æ‰‹æœº: æ»‘åŠ¨ç§»åŠ¨ | ç‚¹åœ†åœˆæš‚åœ',
      selectMode:'é€‰æ‹©æ¨¡å¼',levels:'æ™®é€šå…³å¡',special:'ç‰¹æ®Šç©æ³•',
      special1:'ç‰¹æ®Š1',time:'æ—¶é—´',stage:'é˜¶æ®µ',target:'ç›®æ ‡',
      signTitle:'æ¯æ—¥ç­¾åˆ°',signDesc:'æ¯æ—¥ç­¾åˆ°é¢†å–é‡‘å¸ï¼Œç´¯è®¡å¤©æ•°è§£é”é™å®šå¥–åŠ±ï¼',
      checkInToday:'ä»Šæ—¥ç­¾åˆ°',close:'å…³é—­',totalSign:'ç´¯è®¡ç­¾åˆ°ï¼š{num} å¤©',
      day:'ç¬¬{num}å¤©',reward7:'7å¤©',reward30:'30å¤©',reward50:'50å¤©',
      reward7Content:'5000é‡‘å¸',reward30Content:'20000é‡‘å¸',reward50Content:'é™å®šçš®è‚¤',
      checked:'å·²ç­¾åˆ°',today:'ä»Šæ—¥',unlocked:'å·²è§£é”'
    },
    en: {
      start:'Start Game',selectLevel:'Select Level',back:'Back',tutorial:'Tutorial',
      level1:'Level 1',level2:'Level 2',level3:'Level 3',level4:'Level 4',
      chooseDevice:'Choose Control',keyboard:'Keyboard',mobile:'Touch',
      keyboardGuide:'Use â†‘ â†“ â† â†’ to move',mobileGuide:'Swipe to move',
      ok:'OK',goal:'Goal: Eat food',notice:'Notice: Die if hit wall/self',
      speedNotice:'Notice: Speed increases when eating food',
      obstacleNotice:'Notice: Avoid red obstacles!',
      specialGoal1:'Stage 1: Eat as much as possible quickly\nTarget: 80',
      specialGoal2:'Stage 2: Eat as much as possible quickly\nTarget: 140',
      specialGoal3:'Final Stage: Get the highest score!',
      stageStart:'Entering Stage',
      tabletNotice:'Tablet users can switch control anytime',
      skipTutorial:'Skip tutorial?',gameOver:'Game Over',
      tutorialComplete:'Tutorial Complete!',victory:'Victory!',finalWin:'You Win!',
      perfect:'Perfect!',score:'Score',nextLevel:'Next Level Soon',playAgain:'Play Again',
      backToMenu:'Back to Menu',
      tips:'PC: â†‘â†“â†â†’ | Space=Pause | Mobile: Swipe | Tap circle to pause',
      selectMode:'Select Mode',levels:'Levels',special:'Special',
      special1:'Special 1',time:'Time',stage:'Stage',target:'Target',
      signTitle:'Daily Check-in',signDesc:'Check in daily for gold, unlock rewards with total days!',
      checkInToday:'Check in Today',close:'Close',totalSign:'Total Check-in: {num} days',
      day:'Day {num}',reward7:'7 Days',reward30:'30 Days',reward50:'50 Days',
      reward7Content:'5000 Coins',reward30Content:'20000 Coins',reward50Content:'Limited Skin',
      checked:'Checked',today:'Today',unlocked:'Unlocked'
    }
  };

  // ========== æ ¸å¿ƒé€‚é…å‡½æ•° ==========
  function autoFitScreen() {
    const root = document.documentElement;
    const baseWidth = 400; // åŸºå‡†å®½åº¦
    const screenWidth = window.innerWidth;
    const screenHeight = window.innerHeight;

    // è®¡ç®—æœ€å¤§å¯ç”¨å®½åº¦ï¼šç«–å±å–å±å¹•å®½åº¦çš„85%ï¼Œæ¨ªå±å–å±å¹•é«˜åº¦çš„75%ï¼Œä¿è¯æ£‹ç›˜æ˜¯æ­£æ–¹å½¢ä¸æº¢å‡º
    let maxAvailableWidth;
    if (window.innerWidth < window.innerHeight) {
      // ç«–å±ï¼ˆæ‰‹æœºï¼‰
      maxAvailableWidth = Math.min(screenWidth * 0.85, screenHeight * 0.75);
    } else {
      // æ¨ªå±ï¼ˆç”µè„‘/iPadï¼‰
      maxAvailableWidth = Math.min(screenWidth * 0.6, screenHeight * 0.8, baseWidth);
    }

    // è®¡ç®—ç¼©æ”¾æ¯”ä¾‹ï¼Œæœ€å°ä¸ä½äº0.5ï¼Œä¿è¯æœ€å°å±å¹•ä¹Ÿèƒ½çœ‹æ¸…
    const scale = Math.max(maxAvailableWidth / baseWidth, 0.5);
    
    // æ›´æ–°CSSå˜é‡ï¼Œæ‰€æœ‰å…ƒç´ è‡ªåŠ¨ç¼©æ”¾
    root.style.setProperty('--scale', scale);

    // æ¸¸æˆæ­£åœ¨è¿è¡Œæ—¶ï¼Œé‡æ–°æ¸²æŸ“æ£‹ç›˜ï¼Œé¿å…é”™ä½
    if (isGameStarted && !isPaused) {
      draw();
    }
  }

  // ç›‘å¬å±å¹•å˜åŒ–ï¼šé¡µé¢åŠ è½½ã€çª—å£å¤§å°æ”¹å˜ã€å±å¹•æ—‹è½¬ï¼Œè‡ªåŠ¨é‡æ–°é€‚é…
  window.addEventListener('load', autoFitScreen);
  window.addEventListener('resize', autoFitScreen);
  window.addEventListener('orientationchange', () => {
    setTimeout(autoFitScreen, 100); // è½¬å±åå»¶è¿Ÿ100msé€‚é…ï¼Œä¿è¯è·å–åˆ°æ­£ç¡®çš„å°ºå¯¸
  });

  // é‡‘å¸æ›´æ–°å‡½æ•°
  function updateGoldCount() {
    goldCount.innerText = `ğŸ’° ${userGold}`;
    localStorage.setItem('userGold', userGold);
  }

  // ç­¾åˆ°ç³»ç»Ÿæ ¸å¿ƒå‡½æ•°
  function initSignSystem() {
    renderSignList();
    updateSignProgress();
    updateRewardStatus();
    const isSignedToday = lastSignDate === today;
    doSignBtn.disabled = isSignedToday;
    doSignBtn.classList.toggle('checked', isSignedToday);
    doSignBtn.innerText = isSignedToday ? (lang === 'en' ? 'Checked' : 'å·²ç­¾åˆ°') : langText[lang].checkInToday;
  }

  function renderSignList() {
    signList.innerHTML = '';
    for (let i = 0; i < 7; i++) {
      const date = new Date();
      date.setDate(date.getDate() - (6 - i));
      const dateStr = date.toISOString().split('T')[0];
      const isToday = dateStr === today;
      const isChecked = lastSignDate >= dateStr && totalSignDays > (6 - i);

      const item = document.createElement('div');
      item.className = `sign-item ${isChecked ? 'checked' : ''} ${isToday ? 'today' : ''}`;
      item.innerHTML = `
        <div class="sign-day">${isToday ? langText[lang].today : langText[lang].day.replace('{num}', i+1)}</div>
        <div class="sign-reward">${DAILY_GOLD}</div>
      `;
      signList.appendChild(item);
    }
  }

  function updateSignProgress() {
    const progress = Math.min((totalSignDays / 50) * 100, 100);
    progressFill.style.width = `${progress}%`;
    progressText.innerText = langText[lang].totalSign.replace('{num}', totalSignDays);
  }

  function updateRewardStatus() {
    if (totalSignDays >= 7 && !unlockedReward7) {
      unlockedReward7 = true;
      userGold += 5000;
      updateGoldCount();
      localStorage.setItem('unlockedReward7', 'true');
    }
    if (totalSignDays >= 30 && !unlockedReward30) {
      unlockedReward30 = true;
      userGold += 20000;
      updateGoldCount();
      localStorage.setItem('unlockedReward30', 'true');
    }
    if (totalSignDays >= 50 && !unlockedReward50) {
      unlockedReward50 = true;
      localStorage.setItem('unlockedReward50', 'true');
    }
    reward7.classList.toggle('unlocked', unlockedReward7);
    reward30.classList.toggle('unlocked', unlockedReward30);
    reward50.classList.toggle('unlocked', unlockedReward50);
    reward7.querySelector('.reward-content').innerText = unlockedReward7 ? langText[lang].unlocked : langText[lang].reward7Content;
    reward30.querySelector('.reward-content').innerText = unlockedReward30 ? langText[lang].unlocked : langText[lang].reward30Content;
    reward50.querySelector('.reward-content').innerText = unlockedReward50 ? langText[lang].unlocked : langText[lang].reward50Content;
  }

  function doSign() {
    if (lastSignDate === today) return;
    userGold += DAILY_GOLD;
    updateGoldCount();
    totalSignDays += 1;
    lastSignDate = today;
    localStorage.setItem('totalSignDays', totalSignDays);
    localStorage.setItem('lastSignDate', lastSignDate);
    initSignSystem();
    alert(lang === 'en' ? `Check in success! +${DAILY_GOLD} Coins` : `ç­¾åˆ°æˆåŠŸï¼è·å¾— ${DAILY_GOLD} é‡‘å¸`);
  }

  // è¯­è¨€è®¾ç½®å‡½æ•°
  function setLang(newLang) {
    lang = newLang;
    btnEn.classList.toggle('active', lang === 'en');
    btnCn.classList.toggle('active', lang === 'cn');
    startBtn.textContent = langText[lang].start;
    signBtn.textContent = langText[lang].signTitle;
    backFromMode.textContent = langText[lang].back;
    backFromLevels.textContent = langText[lang].back;
    backFromSpecial.textContent = langText[lang].back;
    modeLevels.textContent = langText[lang].levels;
    modeSpecial.textContent = langText[lang].special;
    modeSelect.querySelector('h1').textContent = langText[lang].selectMode;
    levelSelect.querySelector('h1').textContent = langText[lang].selectLevel;
    specialSelect.querySelector('h1').textContent = langText[lang].special;
    tips.textContent = langText[lang].tips;
    document.querySelector('.sign-title').innerText = langText[lang].signTitle;
    document.getElementById('signDesc').innerText = langText[lang].signDesc;
    closeSignBtn.innerText = langText[lang].close;
    reward7.querySelector('.reward-day').innerText = langText[lang].reward7;
    reward30.querySelector('.reward-day').innerText = langText[lang].reward30;
    reward50.querySelector('.reward-day').innerText = langText[lang].reward50;
    initSignSystem();
    updateComingSoonText();
    updateScore();
  }

  function updateComingSoonText() {
    comingSoonElements.forEach(el => {
      el.innerText = lang === 'en' ? 'Coming Soon' : 'æ•¬è¯·æœŸå¾…';
    });
  }

  function saveSpecialProgress() {
    localStorage.setItem('specialUnlockStage3', specialUnlockStage3);
    localStorage.setItem('specialStar1', specialStar1);
    localStorage.setItem('specialStar2', specialStar2);
    localStorage.setItem('specialHighscore', specialHighscore);
  }

  function restartCurrentSpecialStage() {
    clearInterval(gameLoop);
    clearInterval(specialTimer);
    score = 0;
    resetGame();
    startGameLoop();
    startSpecialTimer();
  }

  // ç‰¹æ®Šæ¨¡å¼å¯åŠ¨
  function startSpecial1() {
    isSpecialMode = true;
    specialStage = 1;
    level = 0;
    mainMenu.classList.add('hidden');
    modeSelect.classList.add('hidden');
    specialSelect.classList.add('hidden');
    scoreRow.classList.remove('hidden');
    gameBoard.classList.remove('hidden');
    tips.classList.remove('hidden');
    isGameStarted = true;
    isPaused = false;
    pauseBtn.innerHTML = 'â¸';
    pauseBtn.style.background = '#F44336';
    score = 0;
    clearInterval(gameLoop);
    clearInterval(specialTimer);
    resetGame();
    startGameLoop();
    startSpecialTimer();
  }

  // ç‰¹æ®Šæ¨¡å¼å®šæ—¶å™¨
  function startSpecialTimer() {
    clearInterval(specialTimer);
    if (specialStage === 1) specialTimeLeft = STAGE1_TIME;
    if (specialStage === 2) specialTimeLeft = STAGE2_TIME;
    if (specialStage === 3) specialTimeLeft = STAGE3_TIME;
    timerElement.innerText = `${langText[lang].time}: ${specialTimeLeft}`;
    specialTimer = setInterval(() => {
      if (isPaused || !isGameStarted) return;
      specialTimeLeft--;
      timerElement.innerText = `${langText[lang].time}: ${specialTimeLeft}`;
      if (specialTimeLeft <= 0) { 
        clearInterval(specialTimer); 
        gameOver(); 
      }
    }, 1000);
  }

  // ç‰¹æ®Šæ¨¡å¼é˜¶æ®µæ£€æŸ¥
  function checkSpecialScore() {
    if (specialStage === 1 && score >= STAGE1_SCORE) {
      specialStar1 = true; 
      specialStage = 2;
      saveSpecialProgress(); 
      countdownToNewStage();
    } else if (specialStage === 2 && score >= STAGE2_SCORE) {
      specialStar2 = true; 
      specialUnlockStage3 = true; 
      specialStage = 3;
      saveSpecialProgress(); 
      countdownToNewStage();
    }
  }

  // é˜¶æ®µåˆ‡æ¢å€’è®¡æ—¶
  function countdownToNewStage() {
    clearInterval(gameLoop); 
    clearInterval(specialTimer);
    isPaused = true;

    const m = document.createElement('div'); 
    m.className = 'modal';
    m.innerHTML = `
      <div class="stage-title">${langText[lang].stageStart} ${specialStage}</div>
      <div class="countdown" id="cd">3</div>
    `; 
    document.body.appendChild(m);

    let n = 3;
    const cdElement = document.getElementById('cd');
    const cdInterval = setInterval(() => {
      n--;
      if (n <= 0) {
        clearInterval(cdInterval); 
        document.body.removeChild(m);
        score = 0;
        isPaused = false;
        resetGame(); 
        updateScore();
        startSpecialTimer(); 
        startGameLoop();
      } else { 
        cdElement.innerText = n; 
      }
    }, 800);
  }

  // é¡µé¢æŒ‰é’®äº‹ä»¶ç»‘å®š
  startBtn.onclick = () => { 
    mainMenu.classList.add('hidden'); 
    modeSelect.classList.remove('hidden'); 
    updateComingSoonText(); 
    refreshLevelLock(); 
  };

  signBtn.onclick = () => {
    signModal.classList.remove('hidden');
    initSignSystem();
  };
  closeSignBtn.onclick = () => {
    signModal.classList.add('hidden');
  };
  doSignBtn.onclick = doSign;

  backFromMode.onclick = () => { modeSelect.classList.add('hidden'); mainMenu.classList.remove('hidden'); };
  modeLevels.onclick = () => { modeSelect.classList.add('hidden'); levelSelect.classList.remove('hidden'); refreshLevelLock(); };
  modeSpecial.onclick = () => {
    if (!modeSpecial.classList.contains('locked')) {
      modeSelect.classList.add('hidden'); specialSelect.classList.remove('hidden');
    }
  };
  backFromLevels.onclick = () => { levelSelect.classList.add('hidden'); modeSelect.classList.remove('hidden'); };
  backFromSpecial.onclick = () => { specialSelect.classList.add('hidden'); modeSelect.classList.remove('hidden'); };
  levelTutorial.onclick = () => selectLevel(0);
  level1.onclick = () => { if (hasDoneTutorial) selectLevel(1); };
  level2.onclick = () => { if (unlockedLevel2) selectLevel(2); };
  level3.onclick = () => { if (unlockedLevel3) selectLevel(3); };
  level4.onclick = () => { if (unlockedLevel4) selectLevel(4); };
  special1.onclick = startSpecial1;

  function selectLevel(lv) {
    isSpecialMode = false;
    clearInterval(specialTimer);
    level = lv;
    localStorage.setItem('savedLevel', level);
    score = 0;
    if (level === 0) { askSkipTutorial(); } else { startGame(); }
  }

  function askSkipTutorial() {
    const m = document.createElement('div'); m.className = 'modal';
    m.innerHTML = `
      <div style="font-size:calc(28px * var(--scale)); color:#fff; margin-bottom:calc(20px * var(--scale)); text-align:center;">${langText[lang].skipTutorial}</div>
      <div style="display:flex; gap:calc(10px * var(--scale)); flex-wrap:wrap; justify-content:center;">
        <button class="skip-btn" id="skip-yes">${lang === 'en' ? 'Yes' : 'æ˜¯'}</button>
        <button class="skip-btn" id="skip-no">${lang === 'en' ? 'No' : 'å¦'}</button>
      </div>
    `;
    document.body.appendChild(m);
    m.querySelector('#skip-yes').onclick = () => {
      hasDoneTutorial = true; localStorage.setItem('hasDoneTutorial', 'true');
      document.body.removeChild(m); refreshLevelLock(); selectLevel(1);
    };
    m.querySelector('#skip-no').onclick = () => { document.body.removeChild(m); chooseDevice(); };
  }

  function chooseDevice() {
    const m = document.createElement('div'); m.className = 'modal';
    m.innerHTML = `
      <div style="font-size:calc(30px * var(--scale)); margin-bottom:calc(10px * var(--scale)); color:#fff; text-align:center;">${langText[lang].chooseDevice}</div>
      <div style="display:flex; gap:calc(10px * var(--scale)); flex-wrap:wrap; justify-content:center;">
        <button class="device-btn" id="kb">${langText[lang].keyboard}</button>
        <button class="device-btn" id="tb">${langText[lang].mobile}</button>
      </div>
      <div class="notice">${langText[lang].tabletNotice}</div>
    `;
    document.body.appendChild(m);
    m.querySelector('#kb').onclick = () => { mode='keyboard'; document.body.removeChild(m); showKeyboardGuide(); };
    m.querySelector('#tb').onclick = () => { mode='touch'; document.body.removeChild(m); showTouchGuide(); };
  }

  function showKeyboardGuide() {
    const m = document.createElement('div'); m.className = 'modal';
    m.innerHTML = `<div class="victory-text">${langText[lang].keyboard}</div><div class="final-score">${langText[lang].keyboardGuide}</div><button class="restart-btn">${langText[lang].ok}</button>`;
    document.body.appendChild(m); m.querySelector('.restart-btn').onclick = () => { document.body.removeChild(m); startGame(); };
  }

  function showTouchGuide() {
    const m = document.createElement('div'); m.className = 'modal';
    m.innerHTML = `<div class="victory-text">${langText[lang].mobile}</div><div class="final-score">${langText[lang].mobileGuide}</div><button class="restart-btn">${langText[lang].ok}</button>`;
    document.body.appendChild(m); m.querySelector('.restart-btn').onclick = () => { document.body.removeChild(m); startGame(); };
  }

  function startGame() {
    isSpecialMode = false; clearInterval(specialTimer);
    mainMenu.classList.add('hidden'); levelSelect.classList.add('hidden');
    scoreRow.classList.remove('hidden'); gameBoard.classList.remove('hidden'); tips.classList.remove('hidden');
    isGameStarted = true; isPaused = false;
    pauseBtn.innerHTML = 'â¸'; pauseBtn.style.background = '#F44336';
    score = 0;
    clearInterval(gameLoop);
    resetGame();
    startGameLoop();
  }

  // æ¸¸æˆé‡ç½®å‡½æ•°
  function resetGame() {
    clearInterval(gameLoop); 
    gameBoard.classList.remove('tutorial'); 
    timerElement.innerText = '';
    if (isSpecialMode) {
      gridSize = 20;
      if (specialStage === 1) baseSpeed = 230;
      if (specialStage === 2) baseSpeed = 200;
      if (specialStage === 3) baseSpeed = 170;
      if (specialStage === 1) gameBoard.classList.add('tutorial');
    } else if (level === 0) { 
      gridSize = 20; baseSpeed = 280; gameBoard.classList.add('tutorial');
    } else if (level === 1) { 
      gridSize = 20; baseSpeed = 180;
    } else if (level === 2) { 
      gridSize = 20; baseSpeed = 190;
    } else if (level === 3) { 
      gridSize = 20; baseSpeed = 220;
    } else if (level === 4) { 
      gridSize = 20; baseSpeed = 170;
    }
    speed = baseSpeed;
    snake = [
      {x:Math.floor(gridSize/2),y:Math.floor(gridSize/2)},
      {x:Math.floor(gridSize/2)-1,y:Math.floor(gridSize/2)},
      {x:Math.floor(gridSize/2)-2,y:Math.floor(gridSize/2)}
    ];
    direction = {x:1,y:0};
    updateScore();
    food=spawnFood();
    draw();
  }

  function updateScore() {
    if (isSpecialMode) {
      scoreElement.innerText = `${langText[lang].special1} ${langText[lang].stage}:${specialStage} | ${langText[lang].score}: ${score}`;
    } else {
      let label = [langText[lang].tutorial, langText[lang].level1, langText[lang].level2, langText[lang].level3, langText[lang].level4][level];
      let targetTxt = lang === 'en' ? 'Target' : 'ç›®æ ‡';
      let target = [0, LEVEL1_PASS, LEVEL2_PASS, LEVEL3_PASS, LEVEL4_PASS][level];
      let targetStr = level > 0 ? ` | ${targetTxt}: ${target}` : '';
      scoreElement.innerText = `${label} | ${langText[lang].score}: ${score}${targetStr}`;
    }
  }

  function getRandomColor(){
    return ['#F44336','#E91E63','#9C27B0','#673AB7','#3F51B5','#2196F3','#00BCD4','#4CAF50','#FFEB3B'][Math.floor(Math.random()*9)];
  }

  function spawnFood(){
    let f;
    do{
      f={x:Math.floor(Math.random()*gridSize),y:Math.floor(Math.random()*gridSize),color:getRandomColor()};
    } while (
      snake.some(s=>s.x===f.x&&s.y===f.y)
      || (level===4 && !isSpecialMode && level4Obstacles.some(o=>o.x===f.x&&o.y===f.y))
    );
    return f;
  }

  function moveFoodSmart(){
    if(level!==3||isPaused||isSpecialMode)return;
    const h=snake[0]; const d=Math.hypot(h.x-food.x,h.y-food.y);
    const s=d<4?0.5:d<7?1:1.5;
    let dx=0,dy=0; Math.random()>0.5?(dx=(Math.random()>.5?1:-1)*s):(dy=(Math.random()>.5?1:-1)*s);
    const nx=Math.round(food.x+dx),ny=Math.round(food.y+dy);
    if(nx>=0&&nx<gridSize&&ny>=0&&ny<gridSize&&!snake.some(s=>s.x===nx&&s.y===ny)){ food.x=nx;food.y=ny; }
  }

  // æ¸¸æˆä¸»å¾ªç¯
  function update() {
    if (isPaused || !isGameStarted) return;
    const h = {x: snake[0].x + direction.x, y: snake[0].y + direction.y};

    // ç¢°æ’æ£€æµ‹
    if (
      h.x < 0 || h.x >= gridSize || h.y < 0 || h.y >= gridSize
      || snake.some((s,i)=>i>0&&s.x===h.x&&s.y===h.y)
      || (level===4 && !isSpecialMode && level4Obstacles.some(o=>o.x===h.x&&o.y===h.y))
    ) {
      gameOver();
      return;
    }

    snake.unshift(h);
    let ate = false;
    if (h.x === food.x && h.y === food.y) {
      score += 10; 
      updateScore(); 
      food = spawnFood(); 
      ate = true;
      if (isSpecialMode) checkSpecialScore();
      if (level === 2 && !isSpecialMode) { 
        speed = Math.max(85, speed - 8); 
        startGameLoop(); 
      }
    } else { 
      snake.pop(); 
    }

    if (!isSpecialMode) {
      if (level === 0 && score >= TUTORIAL_PASS) { 
        hasDoneTutorial = true; localStorage.setItem('hasDoneTutorial','true'); 
        tutorialComplete(); 
        return; 
      }
      if (level === 1 && score >= LEVEL1_PASS) { 
        unlockedLevel2 = true; localStorage.setItem('unlockedLevel2','true'); 
        victory(); 
        return; 
      }
      if (level === 2 && score >= LEVEL2_PASS) { 
        unlockedLevel3 = true; localStorage.setItem('unlockedLevel3','true'); 
        victory(); 
        return; 
      }
      if (level === 3 && score >= LEVEL3_PASS) { 
        unlockedLevel4 = true; localStorage.setItem('unlockedLevel4','true'); 
        victory(); 
        return; 
      }
      if (level === 4 && score >= LEVEL4_PASS) { 
        finalWin(); 
        return; 
      }
      if (level === 3 && !ate) setTimeout(moveFoodSmart, 300);
    }
    draw();
  }

  // æ¸¸æˆæ¸²æŸ“
  function draw() {
    gameBoard.innerHTML = ''; 
    const t = document.createElement('div'); 
    t.className = 'tutorial-text';
    if (isSpecialMode && specialStage === 1) {
      t.innerText = langText[lang].specialGoal1;
    } else if (isSpecialMode && specialStage === 2) {
      t.innerHTML = langText[lang].specialGoal2.replace('140', '<span style="color:#f44336;">140</span>');
    } else if (isSpecialMode && specialStage === 3) {
      t.innerText = langText[lang].specialGoal3;
    } else if (!isSpecialMode && level === 0) {
      t.innerText = `${langText[lang].goal}\n${langText[lang].notice}`;
    } else if (!isSpecialMode && level === 2) {
      t.innerText = langText[lang].speedNotice;
    } else if (!isSpecialMode && level === 4) {
      t.innerText = langText[lang].obstacleNotice;
    }
    if (t.innerText || t.innerHTML) gameBoard.appendChild(t);

    // ç»˜åˆ¶ç¬¬å››å…³éšœç¢ç‰©
    if (level === 4 && !isSpecialMode) {
      level4Obstacles.forEach(obs => {
        const o = document.createElement('div');
        o.style.gridColumnStart = obs.x + 1;
        o.style.gridRowStart = obs.y + 1;
        o.className = 'obstacle';
        o.innerText = 'âŒ';
        gameBoard.appendChild(o);
      });
    }

    // ç»˜åˆ¶è›‡
    snake.forEach((s,i)=>{
      const e=document.createElement('div');
      e.style.gridColumnStart = s.x + 1;
      e.style.gridRowStart = s.y + 1;
      e.style.backgroundColor = i===0?'#4CAF50':'#8BC34A';
      gameBoard.appendChild(e);
    });
    // ç»˜åˆ¶é£Ÿç‰©
    const f=document.createElement('div');
    f.style.gridColumnStart = food.x + 1;
    f.style.gridRowStart = food.y + 1;
    f.style.backgroundColor = food.color;
    f.style.border = '1px solid #fff';
    gameBoard.appendChild(f);
  }

  // æ¸¸æˆç»“æŸ&èƒœåˆ©å‡½æ•°
  function gameOver(){
    clearInterval(gameLoop);
    clearInterval(specialTimer);
    if (isSpecialMode) {
      if (score > specialHighscore) {
        specialHighscore = score;
        saveSpecialProgress();
      }
    }
    showModal(langText[lang].gameOver, `${langText[lang].score}: ${score}`, false, true);
  }

  function tutorialComplete(){clearInterval(gameLoop);showModal(langText[lang].tutorialComplete,langText[lang].nextLevel,true,false);}
  function victory(){clearInterval(gameLoop);showModal(langText[lang].victory,langText[lang].nextLevel,true,false);}
  function finalWin(){clearInterval(gameLoop);showModal(langText[lang].finalWin,langText[lang].perfect,false,true);}

  function backToMainMenu() {
    isGameStarted = false;
    isPaused = false;
    clearInterval(gameLoop);
    clearInterval(specialTimer);
    scoreRow.classList.add('hidden');
    gameBoard.classList.add('hidden');
    tips.classList.add('hidden');
    mainMenu.classList.remove('hidden');
    pauseBtn.innerHTML = 'â¸';
    pauseBtn.style.background = '#333';
  }

  function showModal(title,sub,g,r){
    const m=document.createElement('div');m.className='modal';
    const tc=title===langText[lang].gameOver?'gameover-text':'victory-text';
    let extra = '';
    if (isSpecialMode) {
      extra = `
      <div class="star-row">
        <span class="star ${specialStar1 ? 'active' : ''}">â˜…</span>
        <span class="star ${specialStar2 ? 'active' : ''}">â˜…</span>
        <span class="star">${specialHighscore}</span>
      </div>`;
    }
    let btnHtml = '';
    if(r){
      btnHtml = `
        <div style="display:flex; gap:calc(10px * var(--scale)); flex-wrap:wrap; justify-content:center;">
          <button class="restart-btn">${langText[lang].playAgain}</button>
          <button class="back-btn">${langText[lang].backToMenu}</button>
        </div>
      `;
    }
    m.innerHTML=`<div class="${tc}">${title}</div><div class="final-score">${sub}</div>${extra}${btnHtml}`;
    document.body.appendChild(m);
    if(r){
      m.querySelector('.restart-btn').onclick=()=>{
        document.body.removeChild(m); 
        isPaused=false; 
        pauseBtn.innerHTML='â¸'; 
        pauseBtn.style.background='#F44336';
        if (isSpecialMode) { 
          restartCurrentSpecialStage(); 
        } else { 
          score = 0; 
          resetGame(); 
          startGameLoop(); 
        }
      };
      m.querySelector('.back-btn').onclick=()=>{ 
        document.body.removeChild(m); 
        backToMainMenu(); 
      };
    }
    if(g){ setTimeout(()=>{ document.body.removeChild(m); startCountdown(); },1300); }
  }

  function startCountdown(){
    const m=document.createElement('div');m.className='modal';m.innerHTML=`<div class="countdown" id="cd">3</div>`;document.body.appendChild(m);
    const cd=document.getElementById('cd');let n=3;const i=setInterval(()=>{n--;if(n<=0){clearInterval(i);document.body.removeChild(m);level++;localStorage.setItem('savedLevel',level);score=0;resetGame();startGameLoop();}else{cd.innerText=n;}},800);
  }

  // æš‚åœåŠŸèƒ½
  function togglePause(){ if(!isGameStarted)return; isPaused=!isPaused; pauseBtn.innerHTML=isPaused?'â–¶':'â¸'; pauseBtn.style.background=isPaused?'#4CAF50':'#F44336'; }
  pauseBtn.onclick=togglePause;
  function startGameLoop(){clearInterval(gameLoop);gameLoop=setInterval(update,speed);}

  // é”®ç›˜æ§åˆ¶
  document.addEventListener('keydown',e=>{
    if(e.keyCode===32){togglePause();e.preventDefault();}
    if(isPaused||!isGameStarted)return;
    const k=e.keyCode,L=37,U=38,R=39,D=40;
    if(k===L&&direction.x!==1)direction={x:-1,y:0};
    if(k===U&&direction.y!==1)direction={x:0,y:-1};
    if(k===R&&direction.x!==-1)direction={x:1,y:0};
    if(k===D&&direction.y!==-1)direction={x:0,y:1};
  });

  // è§¦æ‘¸æ§åˆ¶
  document.addEventListener('touchstart',e=>{ touchStartX=e.touches[0].clientX; touchStartY=e.touches[0].clientY; });
  document.addEventListener('touchend',e=>{
    if(!isGameStarted||isPaused)return;
    const dx=e.changedTouches[0].clientX-touchStartX;
    const dy=e.changedTouches[0].clientY-touchStartY;
    if(Math.abs(dx)>Math.abs(dy)){
      if(dx>20&&direction.x!==-1)direction={x:1,y:0};else if(dx<-20&&direction.x!==1)direction={x:-1,y:0};
    }else{
      if(dy<-20&&direction.y!==1)direction={x:0,y:-1};else if(dy>20&&direction.y!==-1)direction={x:0,y:1};
    }
  });

  // å…³å¡è§£é”é€»è¾‘
  function refreshLevelLock() {
    level1.classList.toggle('locked', !hasDoneTutorial);
    level1.classList.toggle('active', hasDoneTutorial);
    level2.classList.toggle('locked', !unlockedLevel2);
    level2.classList.toggle('active', unlockedLevel2);
    level3.classList.toggle('locked', !unlockedLevel3);
    level3.classList.toggle('active', unlockedLevel3);
    level4.classList.toggle('locked', !unlockedLevel4);
    level4.classList.toggle('active', unlockedLevel4);
    modeSpecial.classList.toggle('locked', !unlockedLevel3);
  }

  // é¡µé¢åˆå§‹åŒ–
  btnEn.onclick = () => setLang('en');
  btnCn.onclick = () => setLang('cn');
  setLang(lang);
  refreshLevelLock();
  updateComingSoonText();
  updateGoldCount();
</script>
</body>
</html>
