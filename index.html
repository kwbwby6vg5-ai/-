<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
  <title>Snake Game</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      background: #111;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      color: #fff;
      font-family: Arial, sans-serif;
      touch-action: none;
      min-height: 100vh;
    }

    .screen { display: flex; flex-direction: column; align-items: center; gap: 20px; padding: 20px; }
    .hidden { display: none !important; }
    .menu-title { font-size: 36px; color: #4CAF50; }
    
    .mode-btn {
      width: 220px;
      height: 80px;
      border-radius: 16px;
      border: none;
      font-size: 24px;
      font-weight: bold;
      cursor: pointer;
      color: white;
      transition: all 0.2s;
    }
    .mode-btn.levels {
      background-color: #4CAF50;
    }
    .mode-btn.special {
      background-color: #64B5F6;
    }
    .mode-btn.locked {
      background-color: #555;
      cursor: default;
      opacity: 0.6;
    }

    .level-grid {
      display: flex;
      gap: 12px;
      flex-wrap: nowrap;
      justify-content: center;
      margin: 10px 0 20px;
    }
    .level-block {
      width: 80px; height: 80px;
      border-radius: 12px;
      background: #333;
      border: 2px solid #444;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 18px;
      font-weight: bold;
      cursor: pointer;
      color: #fff;
      text-align: center;
      line-height: 1.2;
    }
    .level-block.active { background: #4CAF50; border-color: #8BC34A; }
    .level-block.tutorial { background: #2196F3; border-color: #03A9F4; }
    .level-block.locked { background: #222; border-color: #333; color: #553; cursor: default; }
    
    .menu-btn {
      padding: 12px 24px;
      font-size: 18px;
      border-radius: 12px;
      border: none;
      background: #333;
      color: white;
      min-width: 180px;
      cursor: pointer;
    }
    .menu-btn.primary { background: #4CAF50; }
    .lang-group {
      display: flex;
      gap: 10px;
      margin-top: 10px;
    }
    .lang-btn {
      padding: 8px 16px;
      border-radius: 8px;
      border: none;
      background: #555;
      color: white;
      font-size: 16px;
      cursor: pointer;
    }
    .lang-btn.active { background: #4CAF50; }

    .score-row {
      display: flex;
      align-items: center;
      gap: 12px;
      margin-bottom: 10px;
    }
    #score { font-size: 24px; }
    #timer { font-size: 24px; color: #FFEB3B; margin-left: 10px; }
    #pause-btn {
      width: 48px; height: 48px;
      border-radius: 50%;
      background: #333;
      border: 2px solid #666;
      box-shadow: 0 2px 4 rgba(0,0,0,0.3);
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 20px;
      color: #fff;
      transition: all 0.2s;
    }
    #game-board {
      background: #222;
      display: grid;
      gap: 1px;
      border: 2px solid #444;
      transition: all 0.3s;
      position: relative;
    }
    #game-board.tutorial {
      background-image: linear-gradient(#333 1px, transparent 1px),
                        linear-gradient(90deg, #333 1px, transparent 1px);
      background-size: 20px 20px;
    }
    .tutorial-text {
      position: absolute;
      top: 10px; left: 10px;
      color: #f44336;
      font-size: 14px;
      font-weight: bold;
      line-height: 1.4;
      text-shadow: 0 0 2px #000;
      z-index: 10;
    }
    #tips { margin-top: 10px; color: #888; text-align: center; }

    .modal {
      position: fixed;
      top: 0; left: 0; width: 100%; height: 100%;
      background: rgba(0,0,0,0.9);
      display: flex; flex-direction: column; align-items: center; justify-content: center;
      z-index: 999;
    }
    .device-btn, .skip-btn {
      font-size: 22px;
      padding: 14px 28px;
      margin: 10px;
      border-radius: 12px;
      border: none;
      background: #4CAF50;
      color: white;
      cursor: pointer;
    }
    .notice {
      font-size: 14px;
      color: #FFEB3B;
      margin-top: 15px;
      max-width: 300px;
      text-align: center;
      line-height: 1.4;
    }
    .victory-text {
      font-size: 50px;
      color: #FFEB3B;
      text-shadow: 0 0 15px #FFEB3B;
      margin-bottom: 20px;
    }
    .gameover-text {
      font-size: 50px;
      color: #F44336;
      text-shadow: 0 0 15px #F44336;
      margin-bottom: 20px;
    }
    .countdown {
      font-size: 80px;
      color: #4CAF50;
      font-weight: bold;
      animation: flash 0.6s infinite alternate;
    }
    @keyframes flash { from { opacity: 0.4; } to { opacity: 1; } }
    .final-score { font-size: 28px; margin-bottom: 20px; }
    .restart-btn {
      padding: 12px 24px;
      border: none;
      border-radius: 50px;
      background: #2196F3;
      color: white;
      font-size: 16px;
      cursor: pointer;
    }

    .star-row {
      display: flex;
      gap: 10px;
      margin: 5px 0;
    }
    .star {
      font-size: 24px;
      color: #ccc;
    }
    .star.active {
      color: #FFEB3B;
    }
  </style>
</head>
<body>

<div id="mainMenu" class="screen">
  <h1 class="menu-title">Snake Game</h1>
  <button class="menu-btn primary" id="startBtn">Start</button>
  <div class="lang-group">
    <button class="lang-btn active" id="btn-en">English</button>
    <button class="lang-btn" id="btn-cn">‰∏≠Êñá</button>
  </div>
</div>

<div id="modeSelect" class="screen hidden">
  <h1 class="menu-title">Select Mode</h1>
  <button class="mode-btn levels" id="modeLevels">Levels</button>
  <button class="mode-btn special locked" id="modeSpecial">Special</button>
  <button class="menu-btn" id="backFromMode">Back</button>
</div>

<div id="levelSelect" class="screen hidden">
  <h1 class="menu-title">Select Level</h1>
  <div class="level-grid" id="levelGrid">
    <div class="level-block tutorial" id="level-tutorial">T</div>
    <div class="level-block locked" id="level-1">1</div>
    <div class="level-block locked" id="level-2">2</div>
    <div class="level-block locked" id="level-3">3</div>
    <div class="level-block locked coming-soon">Êï¨ËØ∑ÊúüÂæÖ</div>
    <div class="level-block locked coming-soon">Êï¨ËØ∑ÊúüÂæÖ</div>
  </div>
  <button class="menu-btn" id="backFromLevels">Back</button>
</div>

<div id="specialSelect" class="screen hidden">
  <h1 class="menu-title">Special Modes</h1>
  <div class="level-grid" id="specialGrid">
    <div class="level-block active" id="special1">S1</div>
    <div class="level-block locked coming-soon">Êï¨ËØ∑ÊúüÂæÖ</div>
    <div class="level-block locked coming-soon">Êï¨ËØ∑ÊúüÂæÖ</div>
    <div class="level-block locked coming-soon">Êï¨ËØ∑ÊúüÂæÖ</div>
    <div class="level-block locked coming-soon">Êï¨ËØ∑ÊúüÂæÖ</div>
    <div class="level-block locked coming-soon">Êï¨ËØ∑ÊúüÂæÖ</div>
  </div>
  <button class="menu-btn" id="backFromSpecial">Back</button>
</div>

<div class="score-row hidden" id="scoreRow">
  <div id="score">Score: 0</div>
  <div id="timer">Time: 0</div>
  <button id="pause-btn">‚è∏</button>
</div>
<div id="game-board" class="hidden"></div>
<div id="tips" class="hidden">PC: ‚Üë‚Üì‚Üê‚Üí | Space=Pause | Mobile: Swipe | Tap circle to pause</div>

<script>
  const gameBoard = document.getElementById('game-board');
  const scoreRow = document.getElementById('scoreRow');
  const scoreElement = document.getElementById('score');
  const timerElement = document.getElementById('timer');
  const pauseBtn = document.getElementById('pause-btn');
  const tips = document.getElementById('tips');
  const btnEn = document.getElementById('btn-en');
  const btnCn = document.getElementById('btn-cn');
  const startBtn = document.getElementById('startBtn');
  const mainMenu = document.getElementById('mainMenu');
  const modeSelect = document.getElementById('modeSelect');
  const modeLevels = document.getElementById('modeLevels');
  const modeSpecial = document.getElementById('modeSpecial');
  const backFromMode = document.getElementById('backFromMode');
  const levelSelect = document.getElementById('levelSelect');
  const backFromLevels = document.getElementById('backFromLevels');
  const specialSelect = document.getElementById('specialSelect');
  const backFromSpecial = document.getElementById('backFromSpecial');
  const levelTutorial = document.getElementById('level-tutorial');
  const level1 = document.getElementById('level-1');
  const level2 = document.getElementById('level-2');
  const level3 = document.getElementById('level-3');
  const special1 = document.getElementById('special1');
  const comingSoonElements = document.querySelectorAll('.coming-soon');

  let hasDoneTutorial = localStorage.getItem('hasDoneTutorial') === 'true';
  let unlockedLevel2 = localStorage.getItem('unlockedLevel2') === 'true';
  let unlockedLevel3 = localStorage.getItem('unlockedLevel3') === 'true';
  let savedLevel = parseInt(localStorage.getItem('savedLevel')) || 0;

  let isSpecialMode = false;
  let specialStage = 1;
  let specialUnlockStage3 = localStorage.getItem('specialUnlockStage3') === 'true';
  let specialStar1 = localStorage.getItem('specialStar1') === 'true';
  let specialStar2 = localStorage.getItem('specialStar2') === 'true';
  let specialHighscore = parseInt(localStorage.getItem('specialHighscore') || 0);
  let specialTimeLeft = 0;
  let specialTimer;

  let lang = 'en';
  let mode = null;
  let level = savedLevel;
  let gridSize = 20;
  let speed = 280;
  let baseSpeed = 280;
  let score = 0;
  let snake, food, direction;
  let gameLoop;
  let isGameStarted = false;
  let isPaused = false;
  let touchStartX = 0, touchStartY = 0;

  const STAGE1_TIME = 40;
  const STAGE1_SCORE = 80;
  const STAGE2_TIME = 60;
  const STAGE2_SCORE = 180;
  const STAGE3_TIME = 90;

  function refreshLevelLock() {
    level1.classList.toggle('locked', !hasDoneTutorial);
    level1.classList.toggle('active', hasDoneTutorial);
    level2.classList.toggle('locked', !unlockedLevel2);
    level2.classList.toggle('active', unlockedLevel2);
    level3.classList.toggle('locked', !unlockedLevel3);
    level3.classList.toggle('active', unlockedLevel3);
    modeSpecial.classList.toggle('locked', !unlockedLevel3);
  }

  function updateComingSoonText() {
    const text = lang === 'en' ? 'Coming\nSoon' : 'Êï¨ËØ∑\nÊúüÂæÖ';
    comingSoonElements.forEach(el => el.innerHTML = text);
  }

  const langText = {
    cn: {
      start: 'ÂºÄÂßã', selectLevel: 'ÈÄâÊã©ÂÖ≥Âç°', back: 'ËøîÂõû', tutorial: 'ÊïôÂ≠¶ÂÖ≥', level1: 'Á¨¨‰∏ÄÂÖ≥', level2: 'Á¨¨‰∫åÂÖ≥', level3: 'Á¨¨‰∏âÂÖ≥',
      chooseDevice: 'ÈÄâÊã©ËÆæÂ§á', keyboard: '‚å®Ô∏è ÈîÆÁõò', mobile: 'üì± ÊâãÊú∫', keyboardGuide: '‰ΩøÁî® ‚Üë ‚Üì ‚Üê ‚Üí ÁßªÂä®',
      mobileGuide: 'ÊªëÂä®Â±èÂπïÁßªÂä®', ok: 'Á°ÆÂÆö', goal: 'ÁõÆÊ†áÔºöÂêÉÊéâÈ£üÁâ©', notice: 'Ê≥®ÊÑèÔºöÁ¢∞Â¢ô/Á¢∞Ëá™Â∑±Âç≥Ê≠ª',
      speedNotice: 'Ê≥®ÊÑèÔºöÂêÉÂà∞È£üÁâ©ÂêéÈÄüÂ∫¶‰ºöÂä†Âø´',
      specialGoal: 'ÁõÆÊ†áÔºöÁü≠Êó∂Èó¥ÂÜÖÂ∞ΩÂèØËÉΩÂêÉÊéâÊõ¥Â§öÈ£üÁâ©',
      tabletNotice: 'Âπ≥ÊùøÁî®Êà∑ÂèØÂú®Ê∏∏Áé©‰∏≠ÈöèÊÑèÂàáÊç¢Êìç‰ΩúÊñπÂºè', skipTutorial: 'ÊòØÂê¶Ë∑≥ËøáÊïôÂ≠¶ÂÖ≥Ôºü',
      gameOver: 'Ê∏∏ÊàèÁªìÊùü', tutorialComplete: 'ÊïôÂ≠¶ÂÆåÊàêÔºÅ', victory: 'ÊÅ≠ÂñúËøáÂÖ≥ÔºÅ', finalWin: '‰Ω†Ëµ¢‰∫ÜÔºÅ',
      perfect: 'ÂÆåÁæéÔºÅ', score: 'ÂàÜÊï∞', nextLevel: 'Âç≥Â∞ÜËøõÂÖ•‰∏ã‰∏ÄÂÖ≥', playAgain: 'ÈáçÊñ∞ÂºÄÂßã',
      tips: 'ÁîµËÑëÔºö‚Üë‚Üì‚Üê‚Üí ÁßªÂä® | Á©∫Ê†ºÊöÇÂÅú | ÊâãÊú∫ÔºöÊªëÂä®ÁßªÂä® | ÁÇπÂúÜÂúàÊöÇÂÅú',
      selectMode: 'ÈÄâÊã©Ê®°Âºè', levels: 'ÊôÆÈÄöÂÖ≥Âç°', special: 'ÁâπÊÆäÁé©Ê≥ï',
      special1: 'ÁâπÊÆä1', time: 'Êó∂Èó¥', stage: 'Èò∂ÊÆµ',
      newStage: 'Êñ∞Èò∂ÊÆµ'
    },
    en: {
      start: 'Start', selectLevel: 'Select Level', back: 'Back', tutorial: 'Tutorial', level1: 'Level 1', level2: 'Level 2', level3: 'Level 3',
      chooseDevice: 'Choose Device', keyboard: '‚å®Ô∏è Keyboard', mobile: 'üì± Mobile', keyboardGuide: 'Use ‚Üë ‚Üì ‚Üê ‚Üí to move',
      mobileGuide: 'Swipe to move', ok: 'OK', goal: 'Goal: Eat food', notice: 'Notice: Die if hit wall/self',
      speedNotice: 'Notice: Speed increases when eating food',
      specialGoal: 'Goal: Eat as much food as possible quickly',
      tabletNotice: 'Tablet users can switch control mode anytime while playing', skipTutorial: 'Skip tutorial?',
      gameOver: 'Game Over', tutorialComplete: 'Tutorial Complete!', victory: 'Victory!', finalWin: 'You Win!',
      perfect: 'Perfect!', score: 'Score', nextLevel: 'Next Level Soon', playAgain: 'Play Again',
      tips: 'PC: ‚Üë‚Üì‚Üê‚Üí | Space=Pause | Mobile: Swipe | Tap circle to pause',
      selectMode: 'Select Mode', levels: 'Levels', special: 'Special',
      special1: 'Special1', time: 'Time', stage: 'Stage',
      newStage: 'New Stage'
    }
  };

  function setLang(newLang) {
    lang = newLang;
    btnEn.classList.toggle('active', lang === 'en');
    btnCn.classList.toggle('active', lang === 'cn');
    
    startBtn.textContent = langText[lang].start;
    backFromMode.textContent = langText[lang].back;
    backFromLevels.textContent = langText[lang].back;
    backFromSpecial.textContent = langText[lang].back;
    
    modeSelect.querySelector('h1').textContent = langText[lang].selectMode;
    modeLevels.textContent = langText[lang].levels;
    modeSpecial.textContent = langText[lang].special;
    
    levelSelect.querySelector('h1').textContent = langText[lang].selectLevel;
    specialSelect.querySelector('h1').textContent = langText[lang].special;
    
    tips.textContent = langText[lang].tips;
    updateComingSoonText();
    updateScore();
  }

  function saveSpecialProgress() {
    localStorage.setItem('specialUnlockStage3', specialUnlockStage3);
    localStorage.setItem('specialStar1', specialStar1);
    localStorage.setItem('specialStar2', specialStar2);
    localStorage.setItem('specialHighscore', specialHighscore);
  }

  function startSpecial1() {
    isSpecialMode = true;
    specialStage = 1;
    mainMenu.classList.add('hidden');
    modeSelect.classList.add('hidden');
    specialSelect.classList.add('hidden');
    scoreRow.classList.remove('hidden');
    gameBoard.classList.remove('hidden');
    tips.classList.remove('hidden');
    isGameStarted = true;
    isPaused = false;
    pauseBtn.innerHTML = '‚è∏';
    pauseBtn.style.background = '#F44336';
    resetGame();
    startGameLoop();
    startSpecialTimer();
  }

  function startSpecialTimer() {
    clearInterval(specialTimer);
    if (specialStage === 1) specialTimeLeft = STAGE1_TIME;
    if (specialStage === 2) specialTimeLeft = STAGE2_TIME;
    if (specialStage === 3) specialTimeLeft = STAGE3_TIME;

    specialTimer = setInterval(() => {
      if (isPaused || !isGameStarted) return;
      specialTimeLeft--;
      timerElement.innerText = `${langText[lang].time}: ${specialTimeLeft}`;
      if (specialTimeLeft <= 0) {
        clearInterval(specialTimer);
        gameOver();
      }
    }, 1000);
  }

  function checkSpecialScore() {
    if (specialStage === 1 && score >= STAGE1_SCORE) {
      specialStar1 = true;
      specialStage = 2;
      saveSpecialProgress();
      countdownToNewStage();
    } else if (specialStage === 2 && score >= STAGE2_SCORE) {
      specialStar2 = true;
      specialUnlockStage3 = true;
      specialStage = 3;
      saveSpecialProgress();
      countdownToNewStage();
    }
  }

  function countdownToNewStage() {
    clearInterval(gameLoop);
    clearInterval(specialTimer);
    const m = document.createElement('div');
    m.className = 'modal';
    m.innerHTML = `<div class="countdown" id="cd">3</div>`;
    document.body.appendChild(m);
    let n = 3;
    const cdInterval = setInterval(() => {
      n--;
      if (n <= 0) {
        clearInterval(cdInterval);
        document.body.removeChild(m);
        score = 0;
        resetGame();
        startSpecialTimer();
        startGameLoop();
      } else {
        document.getElementById('cd').innerText = n;
      }
    }, 800);
  }

  startBtn.onclick = () => {
    mainMenu.classList.add('hidden');
    modeSelect.classList.remove('hidden');
    refreshLevelLock();
  };
  backFromMode.onclick = () => { modeSelect.classList.add('hidden'); mainMenu.classList.remove('hidden'); };
  modeLevels.onclick = () => { modeSelect.classList.add('hidden'); levelSelect.classList.remove('hidden'); refreshLevelLock(); };
  modeSpecial.onclick = () => {
    if (!modeSpecial.classList.contains('locked')) {
      modeSelect.classList.add('hidden');
      specialSelect.classList.remove('hidden');
      updateComingSoonText();
    }
  };
  backFromLevels.onclick = () => { levelSelect.classList.add('hidden'); modeSelect.classList.remove('hidden'); };
  backFromSpecial.onclick = () => { specialSelect.classList.add('hidden'); modeSelect.classList.remove('hidden'); };

  levelTutorial.onclick = () => selectLevel(0);
  level1.onclick = () => { if (hasDoneTutorial) selectLevel(1); };
  level2.onclick = () => { if (unlockedLevel2) selectLevel(2); };
  level3.onclick = () => { if (unlockedLevel3) selectLevel(3); };
  special1.onclick = startSpecial1;

  function selectLevel(lv) {
    isSpecialMode = false;
    clearInterval(specialTimer);
    level = lv;
    localStorage.setItem('savedLevel', level);
    if (level === 0) {
      askSkipTutorial();
    } else {
      startGame();
    }
  }

  function askSkipTutorial() {
    const m = document.createElement('div');
    m.className = 'modal';
    m.innerHTML = `
      <div style="font-size:28px; color:#fff; margin-bottom:20px;">${langText[lang].skipTutorial}</div>
      <button class="skip-btn" id="skip-yes">${lang === 'en' ? 'Yes' : 'ÊòØ'}</button>
      <button class="skip-btn" id="skip-no">${lang === 'en' ? 'No' : 'Âê¶'}</button>
    `;
    document.body.appendChild(m);
    m.querySelector('#skip-yes').onclick = () => {
      hasDoneTutorial = true;
      localStorage.setItem('hasDoneTutorial', 'true');
      document.body.removeChild(m);
      refreshLevelLock();
      selectLevel(1);
    };
    m.querySelector('#skip-no').onclick = () => {
      document.body.removeChild(m);
      chooseDevice();
    };
  }

  function chooseDevice() {
    const m = document.createElement('div');
    m.className = 'modal';
    m.innerHTML = `
      <div style="font-size:30px; margin-bottom:10px; color:#fff;">${langText[lang].chooseDevice}</div>
      <button class="device-btn" id="kb">${langText[lang].keyboard}</button>
      <button class="device-btn" id="tb">${langText[lang].mobile}</button>
      <div class="notice">${langText[lang].tabletNotice}</div>
    `;
    document.body.appendChild(m);
    m.querySelector('#kb').onclick = () => { 
      mode='keyboard'; 
      document.body.removeChild(m); 
      showKeyboardGuide(); 
    };
    m.querySelector('#tb').onclick = () => { 
      mode='touch'; 
      document.body.removeChild(m); 
      showTouchGuide(); 
    };
  }

  function showKeyboardGuide() {
    const m = document.createElement('div');
    m.className = 'modal';
    m.innerHTML = `
      <div class="victory-text">${langText[lang].keyboard}</div>
      <div class="final-score">${langText[lang].keyboardGuide}</div>
      <button class="restart-btn">${langText[lang].ok}</button>
    `;
    document.body.appendChild(m);
    m.querySelector('.restart-btn').onclick = () => { 
      document.body.removeChild(m); 
      startGame(); 
    };
  }

  function showTouchGuide() {
    const m = document.createElement('div');
    m.className = 'modal';
    m.innerHTML = `
      <div class="victory-text">${langText[lang].mobile}</div>
      <div class="final-score">${langText[lang].mobileGuide}</div>
      <button class="restart-btn">${langText[lang].ok}</button>
    `;
    document.body.appendChild(m);
    m.querySelector('.restart-btn').onclick = () => { 
      document.body.removeChild(m); 
      startGame(); 
    };
  }

  function startGame() {
    clearInterval(specialTimer);
    isSpecialMode = false;
    mainMenu.classList.add('hidden');
    levelSelect.classList.add('hidden');
    scoreRow.classList.remove('hidden');
    gameBoard.classList.remove('hidden');
    tips.classList.remove('hidden');
    isGameStarted = true;
    isPaused = false;
    pauseBtn.innerHTML = '‚è∏';
    pauseBtn.style.background = '#F44336';
    resetGame();
    startGameLoop();
  }

  function resetGame() {
    clearInterval(gameLoop);
    gameBoard.classList.remove('tutorial');
    timerElement.innerText = '';

    if (isSpecialMode) {
      gridSize = 20;
      baseSpeed = 220;
      if (specialStage === 1) {
        gameBoard.classList.add('tutorial');
      }
    } else if (level === 0) {
      gridSize = 20; baseSpeed = 280;
      gameBoard.classList.add('tutorial');
    } else if (level === 1) {
      gridSize = 20; baseSpeed = 180;
    } else if (level === 2) {
      gridSize = 20; baseSpeed = 190;
    } else if (level === 3) {
      gridSize = 23; baseSpeed = 160;
    }
    speed = baseSpeed;
    gameBoard.style.gridTemplateColumns = `repeat(${gridSize}, 20px)`;
    gameBoard.style.gridTemplateRows = `repeat(${gridSize}, 20px)`;
    snake = [
      {x:Math.floor(gridSize/2),y:Math.floor(gridSize/2)},
      {x:Math.floor(gridSize/2)-1,y:Math.floor(gridSize/2)},
      {x:Math.floor(gridSize/2)-2,y:Math.floor(gridSize/2)}
    ];
    direction = {x:1,y:0};
    updateScore();
    food=spawnFood();
    draw();
  }

  function updateScore() {
    if (isSpecialMode) {
      scoreElement.innerText = `${langText[lang].special1} ${langText[lang].stage}:${specialStage} | ${langText[lang].score}: ${score}`;
    } else {
      let label;
      if (level === 0) label = langText[lang].tutorial;
      else if (level === 1) label = langText[lang].level1;
      else if (level === 2) label = langText[lang].level2;
      else label = langText[lang].level3;
      scoreElement.innerText = `${label} | ${langText[lang].score}: ${score}`;
    }
  }

  function getRandomColor(){
    const c=['#F44336','#E91E63','#9C27B0','#673AB7','#3F51B5','#2196F3','#00BCD4','#4CAF50','#FFEB3B'];
    return c[Math.floor(Math.random()*c.length)];
  }
  function spawnFood(){
    let f;
    do{
      f={x:Math.floor(Math.random()*gridSize),y:Math.floor(Math.random()*gridSize),color:getRandomColor()};
    }while(snake.some(s=>s.x===f.x&&s.y===f.y));
    return f;
  }
  function moveFoodSmart(){
    if(level!==3||isPaused||isSpecialMode)return;
    const h=snake[0];
    const d=Math.hypot(h.x-food.x,h.y-food.y);
    const s=d<4?0.5:d<7?1:1.5;
    let dx=0,dy=0;
    Math.random()>0.5?(dx=(Math.random()>.5?1:-1)*s):(dy=(Math.random()>.5?1:-1)*s);
    const nx=Math.round(food.x+dx),ny=Math.round(food.y+dy);
    if(nx>=0&&nx<gridSize&&ny>=0&&ny<gridSize&&!snake.some(s=>s.x===nx&&s.y===ny)){
      food.x=nx;food.y=ny;
    }
  }

  function update() {
    if (isPaused || !isGameStarted) return;
    const h = {x: snake[0].x + direction.x, y: snake[0].y + direction.y};
    if (h.x < 0 || h.x >= gridSize || h.y < 0 || h.y >= gridSize || snake.some((s,i)=>i>0&&s.x===h.x&&s.y===h.y)) {
      gameOver(); return;
    }
    snake.unshift(h);
    let ate = false;
    if (h.x === food.x && h.y === food.y) {
      score += 10;
      updateScore();
      food = spawnFood();
      ate = true;
      if (isSpecialMode) checkSpecialScore();
      if (level === 2 && !isSpecialMode) {
        speed = Math.max(85, speed - 8);
        startGameLoop();
      }
    } else {
      snake.pop();
    }

    if (!isSpecialMode) {
      if (level === 0 && score >= 40) {
        hasDoneTutorial = true;
        localStorage.setItem('hasDoneTutorial','true');
        tutorialComplete(); return;
      }
      if (level === 1 && score >= 150) {
        unlockedLevel2 = true;
        localStorage.setItem('unlockedLevel2','true');
        victory(); return;
      }
      if (level === 2 && score >= 150) {
        unlockedLevel3 = true;
        localStorage.setItem('unlockedLevel3','true');
        victory(); return;
      }
      if (level === 3 && score >= 150) {
        finalWin(); return;
      }
      if (level === 3 && !ate) setTimeout(moveFoodSmart, 300);
    }
    draw();
  }

  function draw() {
    gameBoard.innerHTML = '';
    const t = document.createElement('div');
    t.className = 'tutorial-text';
    
    if (isSpecialMode && specialStage === 1) {
      t.innerText = langText[lang].specialGoal;
    } else if (!isSpecialMode && level === 0) {
      t.innerText = `${langText[lang].goal}\n${langText[lang].notice}`;
    } else if (!isSpecialMode && level === 2) {
      t.innerText = langText[lang].speedNotice;
    }
    
    if (t.innerText) {
      gameBoard.appendChild(t);
    }

    snake.forEach((s,i)=>{
      const e=document.createElement('div');
      e.style.gridColumnStart=s.x+1;
      e.style.gridRowStart=s.y+1;
      e.style.backgroundColor=i===0?'#4CAF50':'#8BC34A';
      gameBoard.appendChild(e);
    });
    const f=document.createElement('div');
    f.style.gridColumnStart=food.x+1;
    f.style.gridRowStart=food.y+1;
    f.style.backgroundColor=food.color;
    f.style.border='1px solid #fff';
    gameBoard.appendChild(f);
  }

  function gameOver(){
    clearInterval(gameLoop);
    clearInterval(specialTimer);
    showModal(langText[lang].gameOver, `${langText[lang].score}: ${score}`, false, true);
  }
  function tutorialComplete(){clearInterval(gameLoop);showModal(langText[lang].tutorialComplete,langText[lang].nextLevel,true,false);}
  function victory(){clearInterval(gameLoop);showModal(langText[lang].victory,langText[lang].nextLevel,true,false);}
  function finalWin(){clearInterval(gameLoop);showModal(langText[lang].finalWin,langText[lang].perfect,false,true);}

  function showModal(title,sub,g,r){
    const m=document.createElement('div');m.className='modal';
    const tc=title===langText[lang].gameOver?'gameover-text':'victory-text';
    let extra = '';
    if (isSpecialMode) {
      extra = `
        <div class="star-row">
          <span class="star ${specialStar1 ? 'active' : ''}">‚òÖ</span>
          <span class="star ${specialStar2 ? 'active' : ''}">‚òÖ</span>
          <span class="star">${specialHighscore}</span>
        </div>
      `;
    }
    const rh=r?`<button class="restart-btn">${langText[lang].playAgain}</button>`:'';
    m.innerHTML=`<div class="${tc}">${title}</div><div class="final-score">${sub}</div>${extra}${rh}`;
    document.body.appendChild(m);
    if(r){
      m.querySelector('.restart-btn').onclick=()=>{
        document.body.removeChild(m);
        isPaused=false;
        pauseBtn.innerHTML='‚è∏';
        pauseBtn.style.background='#F44336';
        if (isSpecialMode) {
          startSpecial1();
        } else {
          resetGame();
          startGameLoop();
        }
      };
    }
    if(g){
      setTimeout(()=>{
        document.body.removeChild(m);
        startCountdown();
      },1300);
    }
  }

  function startCountdown(){
    const m=document.createElement('div');m.className='modal';m.innerHTML=`<div class="countdown" id="cd">3</div>`;document.body.appendChild(m);
    const cd=document.getElementById('cd');let n=3;const i=setInterval(()=>{n--;if(n<=0){clearInterval(i);document.body.removeChild(m);level++;localStorage.setItem('savedLevel',level);resetGame();startGameLoop();}else{cd.innerText=n;}},800);
  }

  function togglePause(){
    if(!isGameStarted)return;
    isPaused=!isPaused;
    pauseBtn.innerHTML=isPaused?'‚ñ∂':'‚è∏';
    pauseBtn.style.background=isPaused?'#4CAF50':'#F44336';
  }
  pauseBtn.onclick=togglePause;
  function startGameLoop(){clearInterval(gameLoop);gameLoop=setInterval(update,speed);}

  document.addEventListener('keydown',e=>{
    if(e.keyCode===32){togglePause();e.preventDefault();}
    if(isPaused||!isGameStarted)return;
    const k=e.keyCode,L=37,U=38,R=39,D=40;
    if(k===L&&direction.x!==1)direction={x:-1,y:0};
    if(k===U&&direction.y!==1)direction={x:0,y:-1};
    if(k===R&&direction.x!==-1)direction={x:1,y:0};
    if(k===D&&direction.y!==-1)direction={x:0,y:1};
  });

  document.addEventListener('touchstart',e=>{
    touchStartX=e.touches[0].clientX;
    touchStartY=e.touches[0].clientY;
  });

  document.addEventListener('touchend',e=>{
    if(!isGameStarted||isPaused)return;
    const x=e.changedTouches[0].clientX;
    const y=e.changedTouches[0].clientY;
    const dx=x-touchStartX;
    const dy=y-touchStartY;
    if(Math.abs(dx)>Math.abs(dy)){
      if(dx>20&&direction.x!==-1)direction={x:1,y:0};
      if(dx<-20&&direction.x!==1)direction={x:-1,y:0};
    }else{
      if(dy<-20&&direction.y!==1)direction={x:0,y:-1};
      if(dy>20&&direction.y!==-1)direction={x:0,y:1};
    }
  });
  
  btnEn.onclick = () => setLang('en');
  btnCn.onclick = () => setLang('cn');

  setLang(lang);
  refreshLevelLock();
</script>
</body>
</html>
